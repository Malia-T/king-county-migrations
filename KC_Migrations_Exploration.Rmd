---
title: "ACS County Migration Flows 2019-2020"
author: "Malia Cortez"
date: "2024-01-31"
output: html_document
---

```{r setup, include=FALSE}
# data manipulation and reading
library(dplyr)
library(tidyverse)
library(tidyr)
library(stringr)
library(data.table)
library(readxl)
library(tigris)

# statistics
library(stats)

# mapping and plotting
library(ggplot2)
library(terra)
library(mapdeck)
library(mapboxapi)
library(sf)

# modeling
library(tree)
library(randomForest)
library(randomForestExplainer)
library(keras)

# extracting survey/IPUMS/census data
library(survey)
library(srvyr)
library(ipumsr)
library(tidycensus)
```

Migration, race, and total population data from ACS via the `tidycensus` package. Median house value data from from NHGIS IPUMS.

## Variables
- Tidycensus
  - 
```{r}
v20 <- load_variables(2020, "acs5", cache = TRUE)

View(v20)

# Seattle-Tacoma-Bellevue
# MSA FIPS: 42660


```


## Load in Data
```{r}
#### OLD #### 
# all data from ACS. Data analyzed is from 2019
# try to load in demographics at some point with "breakdown"
acs_county_flows.2019 <- get_flows(geography = "county",
                           state="WA",
                           year = 2019,
                           geometry = TRUE)

acs_county_flows.2020 <- get_flows(geography = "county",
                           state="WA",
                           year = 2020,
                           geometry = TRUE)

# load in county population data
dat <- read.csv("data/county_pops.csv")

# gut checking
head(acs_county_flows.2019)

# load in county characteristics
## AKSME001: total
## AKSME002: White alone
## AKSME003: Black or African American alone
## AKSME004: American Indian and Alaska Native alone
## AKSME005: Asian alone
## AKSME006: Native Hawaiian and Other Pacific Islander alone
## AKSME007: Some other race alone
## AKSME008: Two or more races
## AKSME009: Two or more races: Two races including Some other race
## AKSME010: Two or more races: Two races excluding Some other race, and three or more races
acs_char_2019 <- read.csv("data/nhgis_sex_race.csv")
```

``` {r}
#### TIME SERIES DATA ####
# race composition of MSAs from 1990 to 2020

# geography standardized to 2010 geography
race_ts <- read_nhgis("data/nhgis0005_csv/nhgis0005_csv/nhgis0005_ts_geog2010_cbsa.csv")
head(race_ts)

race_1990_2020_codebook <- read_nhgis_codebook("data/nhgis0005_csv/nhgis0005_csv/", file_select = "nhgis0005_ts_geog2010_cbsa_codebook.txt")

##### Housing Data #####
med_housing_2011_2015 <- read_nhgis("data/nhgis0006_csv/nhgis0006_ds215_20155_cbsa.csv")
med_housing_2016_2020 <- read_nhgis("data/nhgis0006_csv/nhgis0006_ds249_20205_cbsa.csv")
```

### Race Data by MSA
NHGIS code:  U7J
        U7J001:      Total
        U7J002:      White alone
        U7J003:      Black or African American alone
        U7J004:      American Indian and Alaska Native alone
        U7J005:      Asian alone
        U7J006:      Native Hawaiian and Other Pacific Islander alone
        U7J007:      Some Other Race alone
        U7J008:      Two or More Races
```{r}
race_by_cbsa_2020 <- read.csv("data/nhgis0007_ds258_2020_cbsa.csv")
```


## Data Wrangling
```{r}
#### OLD ####
# select name and population
county_pops_2019 <- dat %>% 
  select(c(NAME_M, AKSLE001))

# narrow to just king county
kc_flows_2019 <- acs_county_flows.2019 %>% 
  filter(FULL1_NAME == "King County, Washington") %>% 
  select(c(FULL1_NAME, FULL2_NAME, variable, estimate))

head(kc_flows_2019)

# filter for just "MOVEDOUT"
kc_movers_2019 <- kc_flows_2019 %>% 
  filter(variable=="MOVEDOUT")

# filter for county characteristics

head(kc_movers_2019)
```
```{r}
#### OLD ####
## AKSME001: total
## AKSME002: White alone
## AKSME003: Black or African American alone
## AKSME004: American Indian and Alaska Native alone
## AKSME005: Asian alone
## AKSME006: Native Hawaiian and Other Pacific Islander alone
## AKSME007: Some other race alone
## AKSME008: Two or more races
## AKSME009: Two or more races: Two races including Some other race
## AKSME010: Two or more races: Two races excluding Some other race, and three or more races

county_race <- acs_char_2019 %>% 
  dplyr::select(c(NAME_E, AKSME001, AKSME002, AKSME003, AKSME004, AKSME005, AKSME006, AKSME007, AKSME008, AKSME009, AKSME010))

# rename columns
setnames(county_race, old=c("NAME_E", "AKSME001", "AKSME002", "AKSME003", "AKSME004", "AKSME005", "AKSME006", "AKSME007", "AKSME008", "AKSME009", "AKSME010"), new=c("county_name", "total", "white_alone", "black_alone", "amer_ind_ak_alone", "asian_alone", "nat_haw_pac_alone", "other_alone", "two_plus_alone", "two_some_other", "two_ex_some_three_plus"))

head(county_race)
```

``` {r}
#### HOUSING DATA ####
med_h_2011_2015 <- med_housing_2011_2015 %>% 
  dplyr::select(c(GISJOIN, YEAR, CBSAA, NAME_E, ADRWE001)) %>% 
  dplyr::mutate(median_cost = ADRWE001) %>% 
  dplyr::select(-ADRWE001)

med_h_2016_2020 <- med_housing_2016_2020 %>% 
  dplyr::select(c(GISJOIN, YEAR, CBSAA, NAME_E, AMWBE001)) %>% 
  dplyr::mutate(median_cost = AMWBE001) %>% 
  dplyr::select(-AMWBE001)

median_housing_2011_2020 <- inner_join(med_h_2011_2015, med_h_2016_2020, by = "GISJOIN") %>% 
  mutate(housing_chg = median_cost.y - median_cost.x)

median_housing_2011_2020$CBSAA.x <- as.character(median_housing_2011_2020$CBSAA.x)
  
##### RACE DATA #####
#race_ts <- set_ipums_var_attributes(race_1990_2020, race_1990_2020_codebook$var_info)
# race data from 1990 to 2020
print(ipums_var_info(race_ts))

# only select estimate for each race
race_1990_2020 <- race_ts %>% 
  dplyr::select(c(GISJOIN, GEOGYEAR, CBSA, 
           CM1AA1990, CM1AA2000, CM1AA2010, CM1AA2020,
           CM1AB1990, CM1AB2000, CM1AB2010, CM1AB2020,
           CM1AC1990, CM1AC2000, CM1AC2010, CM1AC2020,
           CM1AD1990, CM1AD2000, CM1AD2010, CM1AD2020,
           CM1AE1990, CM1AE2000, CM1AE2010, CM1AE2020,
           CM1AF1990, CM1AF2000, CM1AF2010, CM1AF2020,
           CM1AG1990, CM1AG2000, CM1AG2010, CM1AG2020))

head(race_1990_2020)

#### Calculate change over time for each group ####
## consider getting rid of 1990 - 2000: from a while ago
## starting in 2000 census, people could mark themselves as multiracial also ^
race_2000_2020 <- race_1990_2020 %>% 
  mutate(chg_white_2000_2010 = CM1AA2010 - CM1AA2000,
         chg_white_2010_2020 = CM1AA2020 - CM1AA2010,
         chg_black_2000_2010 = CM1AB2010 - CM1AB2000,
         chg_black_2010_2020 = CM1AB2020 - CM1AB2010,
         chg_aiak_2000_2010 = CM1AC2010 - CM1AC2000,
         chg_aiak_2010_2020 = CM1AC2020 - CM1AC2010,
         chg_asian_2000_2010 = CM1AD2010 - CM1AD2000,
         chg_asian_2010_2020 = CM1AD2020 - CM1AD2010,
         chg_nhpi_2000_2010 = CM1AE2010 - CM1AE2000,
         chg_nhpi_2010_2020 = CM1AE2020 - CM1AE2010,
         chg_other_2000_2010 = CM1AF2010 - CM1AF2000,
         chg_other_2010_2020 = CM1AF2020 - CM1AF2010,
         chg_twoplus_2000_2010 = CM1AG2010 - CM1AG2000,
         chg_twoplus_2010_2020 = CM1AG2020 - CM1AG2010) %>% 
  dplyr::select(c(GISJOIN, CBSA, chg_white_2000_2010, chg_white_2010_2020, chg_black_2000_2010,
           chg_black_2010_2020, chg_aiak_2000_2010, chg_aiak_2010_2020,
           chg_asian_2000_2010, chg_asian_2010_2020, chg_nhpi_2000_2010,
           chg_nhpi_2010_2020, chg_other_2000_2010, chg_other_2010_2020,
           chg_twoplus_2000_2010, chg_twoplus_2010_2020))
```


```{r}
#### OLD ####
# join movers with county data
# outer join
county_moves <- merge(kc_movers_2019, county_pops_2019, by.x="FULL2_NAME", by.y = "NAME_M", all.y=TRUE) %>%
  select(-(variable))

county_moves$FULL1_NAME <- "King County, Washington"

# rename variables
names(county_moves)[names(county_moves) == 'AKSLE001'] <- 'tot_pop'
names(county_moves)[names(county_moves) == 'estimate'] <- 'movers'
names(county_moves)[names(county_moves) == 'FULL2_NAME'] <- 'county2'
names(county_moves)[names(county_moves) == 'FULL1_NAME'] <- 'county1'

```


### Blank Cells
For county-to-county migration data, estimates may be blank because:

1. Estimate is out of scope (world regions)
2. Estimate DNE - an example would be movers to a different county in same state for Washington, DC (likely doesn't apply for King County)
3. Supplemental statistics for county of residence one year ago or MCD of residence one year ago suppressed due to disclosure avoidance

**Flows with no records in the database and suppressed flows crossed by characteristics are not included in the files. The flows with no records are considered zero count estimates.**

I only included other US regions in this analysis. Further, I did a right join, with the right database being all US counties. For these reasons, I am assuming it is reasonable to just put "0" for blank estimates.

```{r}
# replace NAs in dataset with 0
county_moves[is.na(county_moves)] <- 0
```

```{r}
# make sure to remove the row with "King County" as county2
head(county_moves)

# calculate pct county characteristics
```


## EDA/More Wrangling...

```{r}
# how many NAs in movers?
# plot movers
unique(county_moves$county2)
# 0 (nice)
sum(is.na(county_moves$movers))

# how many NAs in race data?
# 59 NAs
sum(is.na(county_race$total))

# which counties are NA?
# lots of southern counties missing...?
county_race[is.na(county_race$total),]

# are there discrepancies between race data and total pop data?
# king county is the same but let's plot
county_moves[county_moves$county2 == "King County, Washington",]
county_race[county_race$county_name == "King County, Washington",]

plot(county_moves$tot_pop, county_race$total, main = "Total Population (Race vs Pop Table)")
# seems like there are some discrepancies...
plot(county_moves$tot_pop - county_race$total, type='h', ylab = "Difference (County vs. Race Data)")

## most have small differences... will just go with the county population data rather than the race. likely more standardized

# join move data with race data and get rid of county 1 (King County)
county_race_moves <- merge(county_moves, county_race, by.x="county2", by.y = "county_name", all.x=TRUE) %>% 
  select(-c(total, county1))

head(county_race_moves)

# change the weird string stuff
county_race_moves$county2 <- iconv(county_race_moves$county2, "UTF-8", "ASCII", sub = "")
```

```{r}
# which counties saw most people moving from King County?
# top 10
top_10 <- county_race_moves %>% 
  arrange(desc(movers)) %>% 
  slice(1:10)

ggplot(data = top_10, mapping = aes(x = reorder(county2, -movers), y = movers)) +
  geom_col(stat = "identity") +
  theme(axis.text.x = element_text(angle=45, vjust = 1))
```
Lots of movers to nearby counties. Makes sense.

### Trying out more tidycensus functions
```{r}
#test <- get_pums(variables = "NP", year = 2019, state = "WA", survey = "acs1", recode = TRUE)

race_vars <- c(
  Hispanic = "P2_002N",
  White = "P2_005N",
  Black = "P2_006N",
  Asian = "P2_008N"
)

sea_race <- get_decennial(
  geography = "tract",
  variables = race_vars,
  state = "WA",
  county = "King County",
  geometry = TRUE,
  year = 2020
)

sea_dots <- as_dot_density(
  sea_race,
  value = "value",
  values_per_dot = 100,
  group = "variable"
)

sea_base <- sea_race[sea_race$variable == "Hispanic",]

ggplot() +
  geom_sf(data = sea_base,
          fill = 'white',
          color = 'grey') +
  geom_sf(data = sea_dots,
          aes(color = variable),
          size = 1) +
  theme_void()

# TODO: define a function to gather median income, other socioeconomic data
#create_socioecon_data <- function(year) {
  
#}

# test2 <- get_flows(geography = "county subdivision",
#                            state="WA",
#                            #county="King County",
#                            year = 2020,
#                            geometry = TRUE)
```

```{r}
# map flows from 2011 to 2015 (ACS5)
sea_flows_2015 <- get_flows(
  geography = "metropolitan statistical area",
  #breakdown = "RACE",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2015,
  geometry = TRUE
)

# map flows from 2016 to 2020 (ACS5)
sea_flows_2020 <- get_flows(
  geography = "metropolitan statistical area",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2020,
  geometry = TRUE
)

head(sea_flows_2015)
head(sea_flows_2020)
```

### Trying out mapdeck/mapbox
```{r}
# try out mapdeck
## data wrangling
top_move_out <- sea_flows_2015 %>% 
  filter(!is.na(GEOID2), variable == "MOVEDOUT") %>% 
  slice_max(n = 25, order_by = estimate) %>% 
  mutate(
    width = estimate / 500,
    tooltip = paste0(
      scales::comma(estimate * 5, 1),
      " people moved from ", str_remove(FULL1_NAME, "Metro Area"),
      " to ", str_remove(FULL2_NAME, "Metro Area"), " between 2011 and 2015"
    )
  )

# map the top 25 MSAs moving out from WA
top_move_out %>% 
  mapdeck(style=mapdeck_style("dark"), pitch = 45, token = Sys.getenv("MAPBOX_PUBLIC_TOKEN")) %>% 
  add_arc(
    origin = "centroid1",
    destination = "centroid2",
    stroke_width = "width",
    auto_highlight = TRUE,
    highlight_colour = "#8c43facc",
    tooltip = "tooltip"
  ) %>% 
  add_title(title = list(title = "Top 25 Destinations from SEA-TAC-BELL Metropolitan Statistical Areas (2011 - 2015)",
            css = "color: black;"))
```

```{r}
top_move_out <- sea_flows_2020 %>% 
  filter(!is.na(GEOID2), variable == "MOVEDOUT") %>% 
  slice_max(n = 25, order_by = estimate) %>% 
  mutate(
    width = estimate / 500,
    tooltip = paste0(
      scales::comma(estimate * 5, 1),
      " people moved from ", str_remove(FULL1_NAME, "Metro Area"),
      " to ", str_remove(FULL2_NAME, "Metro Area"), " between 2016 and 2020"
    )
  )

# map the top 25 MSAs moving out from WA
top_move_out %>% 
  mapdeck(style=mapdeck_style("dark"), pitch = 45,
          token = Sys.getenv("MAPBOX_PUBLIC_TOKEN")) %>% 
  add_arc(
    origin = "centroid1",
    destination = "centroid2",
    stroke_width = "width",
    auto_highlight = TRUE,
    highlight_colour = "#8c43facc",
    tooltip = "tooltip"
  ) %>% 
  add_title(title = list(title = "Top 25 Destinations from SEA-TAC-BELL Metropolitan Statistical Areas (2016 - 2020)",
            css = "color: black;"))
```

Patterns are relatively comparable between 2015 and 2020.

```{r}
# calculate race percentages and supplement data
# remove "conflicting" race categories
county_race[is.na(county_race$total),]
```

```{r}
# input ACS characteristics for missing counties
# exclude the categories that feed into "two plus"
county_race_moves <- county_race_moves %>% 
  select(-c(two_some_other, two_ex_some_three_plus))

# test this out
race_test <- get_acs(geography = "county", variables = c("B02001_001", "B02001_002", "B02001_003", "B02001_004", "B02001_005", "B02001_006", "B02001_007", "B02001_008"), year = 2019, output="wide") %>% 
    # exclude MOE estimates
    select(-c(B02001_001M, B02001_002M, B02001_003M, B02001_004M, B02001_005M, B02001_006M, B02001_007M, B02001_008M))

sum(is.na(race_test$B02001_003E)) 
```

### Trying out ipumsr package functions with tidycensus
```{r}
median_hou_msa_2019 <- read_nhgis("data/nhgis0004_csv/nhgis0004_ds243_2019_metdiv.csv")

head(median_hou_msa_2019)

mig <- get_flows(
  geography = "metropolitan statistical area",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2019,
  geometry = TRUE
)

head(mig)

sea_tac_bell_flows <- mig %>% 
  select(-moe) %>% 
  filter(FULL1_NAME == "Seattle-Tacoma-Bellevue, WA Metro Area")

head(sea_tac_bell_flows)

# load in time series data for race (1990, 2000, 2010, 2020)
race_change_1990_2020_cbsa <- read_nhgis("data/nhgis0005_csv/nhgis0005_csv/nhgis0005_ts_geog2010_cbsa.csv")

head(race_change_1990_2020_cbsa)
```

```{r}
# TODO: CREATE FUNCTION FOR THIS PROCESS
# movers by race
sea_flows_2015 <- get_flows(
  geography = "metropolitan statistical area",
  breakdown = "RACE",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2015,
  geometry = TRUE
)

movers_by_race_2015 <- sea_flows_2015 %>% 
  dplyr::filter(variable == "MOVEDOUT") %>% 
  dplyr::filter(RACE_label != "All races") %>% 
  dplyr::select(c(RACE_label, variable, estimate))

head(movers_by_race_2015)

total_movers_race <- movers_by_race_2015 %>% 
  group_by(RACE_label) %>% 
  summarize(n = sum(estimate, na.rm = TRUE))

ggplot(data = total_movers_race, mapping = aes(x = RACE_label, y = n)) +
  geom_histogram(na.rm = TRUE, stat = "sum") +
  ggtitle("Distribution of Movers from Seattle-Tacoma-Bellevue MSA (2011-2015)")

# B02001_002: White alone
# B02001_003: Black or African American alone
# B02001_005: Asian alone
# B02001_009: Two or more and other
# TODO: percent movers by race
data <- get_acs(year = 2015, variables = c("B02001_002", "B02001_003", "B02001_005", "B02001_009"), geography = "metropolitan statistical area/micropolitan statistical area")

total_pops_2015 <- data %>% 
  filter(NAME == "Seattle-Tacoma-Bellevue, WA Metro Area")

total_pops_2015 <- total_pops_2015 %>% mutate(
  race = case_when(
    variable == "B02001_002" ~ "White alone",
    variable == "B02001_003" ~ "Black or African American alone",
    variable == "B02001_005" ~ "Asian alone",
    variable == "B02001_009" ~ "Other race alone or Two or more races",
    .default = "other"
))

head(total_pops_2015)

# join pops and movers
pops_movers_2015 <- merge(total_pops_2015, total_movers_race, by.x = "race", by.y = "RACE_label") %>% 
  dplyr::select(-variable)

head(pops_movers_2015)

pops_movers_2015$pct_movers <- pops_movers_2015$n / pops_movers_2015$estimate

ggplot(data = pops_movers_2015, mapping = aes(x = race, y = pct_movers)) +
  geom_histogram(na.rm = TRUE, stat = "sum") +
  ggtitle("Proportion of Race Moving out of Seattle-Tacoma-Bellevue MSA (2011-2015)")
```
2011-2015: While there are more white movers (way outnumber other classes), the percent of people in the "two or more/other" category that are moving out of Seattle-Tacoma-Bellevue vastly outnumbers the other race categories.

## MSA Analysis

There are 387 total MSAs in the country... `sea_flows_2020` has 354 total rows (with some being outside US)
```{r}
med_h_2011_2020 <- median_housing_2011_2020 %>% 
  select(-c(median_cost.y, median_cost.x, NAME_E.x))
```

```{r}
dim(med_h_2011_2015)
head(med_h_2011_2015)

dim(med_h_2016_2020)
head(med_h_2016_2020)

head(med_h_2011_2020)

# see what MSAS are not in the earlier dataset
# 32 MSAs?
View(dplyr::anti_join(med_h_2016_2020, med_h_2011_2015, by = "CBSAA"))

# any difference in naming?
# much larger difference in naming... 82 rows differ
View(dplyr::anti_join(med_h_2016_2020, med_h_2011_2015, by = "NAME_E"))
```

``` {r}
# how many rows have "metro" in title?
s <- race_2010_2020$CBSA

metros <- str_detect(s, "Metro")

# 366 rows with "metro" in race data
# flows has 354 rows
length(metros[metros == TRUE])

s <- med_h_2011_2020$NAME_E.y

metros <- str_detect(s, "Metro")

# 388 rows with "metro" in housing data
length(metros[metros == TRUE])
```
```{r}
anti_join(metros, race_2010_2020, by)
```



```{r}
# attempting to fix the mess with the geometry...
# 2021 cbsa data
cbsa <- core_based_statistical_areas()

# seems like there were more cbsas in 2010
cbsa_2010 <- core_based_statistical_areas(year = 2010)

dim(cbsa)
dim(cbsa_2010)

## HOUSING ##
# full outer join
dim(median_housing_2011_2020)
cbsa_compare_housing <- full_join(cbsa, median_housing_2011_2020, by = c("GEOID" = "CBSAA.x"))

write_csv(cbsa, file="cbsas_2021.csv")
write_csv(cbsa_compare_housing, file = "cbsas_housing.csv")

# 32 missing cbsa from housing data
# 2 are metro areas, the rest are micro areas
# since the flow data only has data for metro areas, we can probably ignore/supplement these manually 
sum(is.na(cbsa_compare_housing$NAME_E.x))

## RACE ##
# extract the GEOID
race_2010_2020$GEOID <- substring(race_2010_2020$GISJOIN, 2)
dim(race_2010_2020)

cbsa_compare_race <- left_join(cbsa, race_2010_2020, by = "GEOID")
```

```{r}
# TODO: standardize to seattle-tacoma-bellevue
sea_flows_2020 <- sea_flows_2020 %>% 
  dplyr::filter(variable == "MOVEDOUT")
head(sea_flows_2020)

head(median_housing_2011_2020)

race_2010_2020 <- race_2000_2020 %>% 
  dplyr::select(c(GISJOIN, CBSA, chg_white_2010_2020, chg_black_2010_2020, chg_aiak_2010_2020, chg_asian_2010_2020, chg_nhpi_2010_2020, chg_other_2010_2020, chg_twoplus_2010_2020))

# some mismatches in the numbers of observations...
# focus on last 10 years for now...

# inner join... might need to rework
flows_housing <- inner_join(sea_flows_2020, median_housing_2011_2020, by = c("GEOID2" = "CBSAA.x"))

race_housing <- inner_join(median_housing_2011_2020, race_2010_2020, by = "GISJOIN") %>% 
  select(-c(GISJOIN, NAME_E.x, YEAR.x, YEAR.y, CBSAA.y, median_cost.x, median_cost.y))

data <- race_housing %>% 
  inner_join(sea_flows_2020, by = c("CBSAA.x" = "FULL2_NAME"))

data2 <- flows_housing %>% 
  inner_join(race_2010_2020, by = c("GEOID2" = "GEOID"))

write_csv(data, file = 'flows_race_housing.csv', sep = ",")
write_csv(data2, file = "flows_race_housing-2.csv")

data_mod <- data %>% 
  dplyr::select(c(estimate, housing_chg, chg_white_2010_2020, chg_black_2010_2020, chg_aiak_2010_2020, chg_asian_2010_2020, chg_nhpi_2010_2020, chg_other_2010_2020, chg_twoplus_2010_2020)) %>% 
  st_drop_geometry()

train <- sample(1:nrow(data_mod), nrow(data_mod) * 0.8)

pcts.train <- data_mod[train,]
pcts.test <- data_mod[-train,]

tree.pcts <- tree(estimate ~ ., data=pcts.train)
summary(tree.pcts)
```
```{r}
plot(tree.pcts)
text(tree.pcts, pretty = 0)
```
```{r}
tree.pred <- predict(tree.pcts, newdata = pcts.test)

mse <- mean((pcts.test$estimate - tree.pred)^2)
rmse <- sqrt(mse)
mae <- mean(abs(pcts.test$estimate - tree.pred))
mape <- mean(abs((pcts.test$estimate - tree.pred) / pcts.test$estimate)) * 100

r_squared <- 1 - sum((pcts.test$estimate - tree.pred)^2) / sum((pcts.test$estimate - mean(pcts.test$estimate))^2)

# pretty ok for just a single tree...
print(paste("MSE", mse, "RMSE", rmse, "MAE", mae, "MAPE", mape, "R-squared", r_squared))
```
```{r}
# random forest with p / 3 ~ 3 trees
rf.moves <- randomForest(estimate ~ ., data = data_mod, subset = train, mtry = 3, importance = TRUE)

yhat.rf <- predict(rf.moves, newdata = data_mod[-train,])

# TODO: adjust to forest
mse <- mean((data_mod[-train,]$estimate - yhat.rf)^2)
rmse <- sqrt(mse)
mae <- mean(abs(pcts.test$estimate - tree.pred))
mape <- mean(abs((pcts.test$estimate - tree.pred) / pcts.test$estimate)) * 100

# about 0.616
r_squared <- 1 - sum((data_mod[-train,]$estimate - yhat.rf)^2) / sum((data_mod[-train,]$estimate - mean(data_mod[-train,]$estimate))^2)
```

```{r}
importance(rf.moves)

varImpPlot(rf.moves, main = "Variable Importance vs Mean Decrease in Accuracy and Gini")
```
```{r}
plot(rf.moves)
```

```{r}
#explain_forest(rf.moves, data = data_mod)
```


## Functions
```{r}
# define functions to clean and join data given year
# TODO: MODIFY TO INCLUDE MULTIPLE YEARS WITH RBIND
create_county_flows <- function(year) {
  # load flows for WA King County
  king_county_flows <- get_flows(geography = "county",
                           state="WA",
                           county="King",
                           year = year,
                           geometry = TRUE)
  
  # filter for just movers out of KC
  king_county_flows <- king_county_flows %>% 
    filter(variable == "MOVEDOUT") %>% 
    select(-c(moe, FULL1_NAME, variable))
  
  # rename migration columns
  setnames(king_county_flows, 
           old=c("FULL2_NAME", "estimate"), 
           new=c("county_name", "movers"))
  
  # call for race data up to "two or more"
  county_races <- get_acs(geography = "county", variables = c("B02001_001", "B02001_002", "B02001_003", "B02001_004", "B02001_005", "B02001_006", "B02001_007", "B02001_008"),
                          year = year, output="wide") %>% 
    # exclude MOE estimates
    select(-c(B02001_001M, B02001_002M, B02001_003M, B02001_004M, B02001_005M, B02001_006M, B02001_007M, B02001_008M))
  
  # rename race columns
  setnames(county_races, 
           old=c("NAME", "B02001_001E", "B02001_002E", "B02001_003E", "B02001_004E", "B02001_005E", "B02001_006E", "B02001_007E", "B02001_008E"), 
           new=c("county_name", "total_pop", "white_alone", "black_alone", "amer_ind_ak_alone", "asian_alone", "nat_haw_pac_alone", "other_alone", "two_plus"))
  
  king_county_comp <- merge(king_county_flows, county_races, by = "county_name", all.y=TRUE) %>% 
    select(-c(GEOID1, GEOID2, centroid2)) %>% 
    data.frame()
  
  king_county_comp[is.na(king_county_comp)] <- 0
  return(king_county_comp)
}
```


```{r}
# define a function to calculate percentages of each race given dataset
calc_percentages <- function(data){
  race_cols <- c("white_alone", "black_alone", "amer_ind_ak_alone", "asian_alone", "nat_haw_pac_alone", "other_alone", "two_plus")
  
  for (race in race_cols) {
    data[[race]] <- (data[[race]] / data$total_pop) * 100
  }
  
  return(data)
}
```

```{r}
# define a function to calculate percent difference between KC and other counties
calc_differences <- function(data) {
  race_cols <- c("white_alone", "black_alone", "amer_ind_ak_alone", "asian_alone", "nat_haw_pac_alone", "other_alone", "two_plus")

  kc <- data[data$county_name == "King County, Washington",]
  
  # get differences between king county and column
  pct_diff <- lapply(race_cols, function(race) {
    data[[race]] - kc[[race]]
  })
  
  # convert to a dataframe
  pct_diff_df <- as.data.frame(pct_diff)
  
  # rename cols
  colnames(pct_diff_df) <- paste0("diff_pct_", race_cols)
  
  # bind percentage differences
  data <- cbind(data, pct_diff_df)
  
  return(data)
}
```


```{r}
# yay!
dat.2019 <- create_county_flows(2019)
pct.2019 <- calc_percentages(dat.2019)

# yay!
# differences calculated by King County - each county
diffs <- calc_differences(pct.2019)
```

## EDA

## Tests
```{r}
# relationship between race and whether someone has moved?
# try for 2015
# contingency table
head(sea_flows_2015)

cont.race <- data.frame(
  "Race" = c("Black", "Non-black"),
  "Moved" = c("Yes", "No")
)
```


## Models

### Tree (Raw Percentages)
```{r}
# exclude KC
pct.2019 <- pct.2019 %>% 
  select(-c(GEOID, centroid2)) %>% 
  filter(county_name != "King County, Washington")
```

```{r}
set.seed(2)

# select variables for analysis
data <- pct.2019 %>% 
  select(c(county_name, movers, white_alone, black_alone, amer_ind_ak_alone, asian_alone, nat_haw_pac_alone, other_alone, two_plus))

# model data
mod1.data <- data %>% 
  select(c(movers, white_alone, black_alone, amer_ind_ak_alone, asian_alone, nat_haw_pac_alone, other_alone, two_plus))

train <- sample(1:nrow(mod1.data), nrow(mod1.data) * 0.8)

pcts.train <- mod1.data[train,]
pcts.test <- mod1.data[-train,]

tree.pcts <- tree(movers ~ ., data=pcts.train)
summary(tree.pcts)
```

```{r}
plot(tree.pcts)
text(tree.pcts, pretty = 0)
```

```{r}
# predict on test set
yhat <- predict(tree.pcts, newdata=pcts.test)

plot(yhat, pcts.test$movers)
abline(0, 1)
```

```{r}
# lmaooo
mean((yhat - pcts.test$movers)^2)
sqrt(mean((yhat - pcts.test$movers)^2))
```


### Tree (Percentage Differences)
```{r}
# exclude KC
diffs <- diffs %>% 
  filter(county_name != "King County, Washington")
```

```{r}
# select data
dat <- diffs %>% 
  select(c(county_name, movers, diff_pct_white_alone, diff_pct_black_alone,
           diff_pct_amer_ind_ak_alone, diff_pct_asian_alone,
           diff_pct_nat_haw_pac_alone, diff_pct_other_alone,
           diff_pct_two_plus))

mod.data <- dat %>% 
  select(c(movers, diff_pct_white_alone, diff_pct_black_alone,
           diff_pct_amer_ind_ak_alone, diff_pct_asian_alone,
           diff_pct_nat_haw_pac_alone, diff_pct_other_alone,
           diff_pct_two_plus))

y <- dat$movers
```

```{r}
# distribution of movers
# mostly 0
ggplot(data = mod.data, mapping = aes(x = movers)) +
  geom_histogram()
```

```{r}
set.seed(2)

# train/test
train <- sample(1:nrow(mod.data), nrow(mod.data) * 0.8)

pcts.train <- mod.data[train,]
pcts.test <- mod.data[-train,]

tree.pcts <- tree(movers ~ ., data=pcts.train)
summary(tree.pcts)
```

```{r}
plot(tree.pcts)
text(tree.pcts, pretty = 0)
```


```{r}
# predict on test set
yhat <- predict(tree.pcts, newdata=pcts.test)

# seem to have some outliers affecting the data
plot(yhat, pcts.test$movers)
abline(0, 1)
```

```{r}
# slightly better MSE
mean((yhat - pcts.test$movers)^2)
sqrt(mean((yhat - pcts.test$movers)^2))
```


```{r}
# try random forest next 
```

```{r}
# try linear model
# low p value... hmm
basic.lin.mod <- lm(movers ~ ., data = mod.data)
summary(basic.lin.mod)
```

```{r}
# TODO: output csv?
write.csv(sea_flows_2020, "data/sea_mig_2020.csv", row.names = FALSE)

write.csv(med_h_2011_2020, "data/msa_med_housing_2011-2020.csv", row.names = FALSE)

write.csv(race_2010_2020, "data/race_2010-2020.csv", row.names = FALSE)
```

```{r}
# TODO: compare acs1, acs3, acs5 results?
```

```{r}
# TODO: are there more movers to areas where race proportions are shifting?
```

```{r}
# TODO: construct probability of moving distributions via ecological inference (black vs non-black, white vs non-white)
## can use 2015 race breakdown as the posterior for Bayesian inference?
```

```{r}
# TODO: after constructing the probability distributions, consider what the implications are given the change in demographics
# are some races more "mobile" than others? able to seek more opportunity? apply to other cities?

```


