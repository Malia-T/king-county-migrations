---
title: "Ecological Inference"
author: "Malia Cortez"
date: "2024-06-23"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(tidyr)
library(stringr)
library(data.table)
library(readxl)
library(tigris)

# statistics
library(stats)

# mapping and plotting
library(ggplot2)
library(terra)
library(mapdeck)
library(sf)

# modeling and inference
library(brms)
library(mcmc)

# modeling
#library(tree)
#library(randomForest)
#library(randomForestExplainer)
#library(keras)

# extracting survey/IPUMS/census data
#library(survey)
#library(srvyr)
library(ipumsr)
library(tidycensus)
```

The purpose of this notebook is to explore ecological inference methods for the migration data. How do movers break down by race? Are there distinguishable groups between white/non-white, black/non-black populations?

## Notes

To help with my understanding, here is the notation for this problem.

If all assumptions are met and we can use King's EI, for each MSA $i$, we want to estimate the race composition of movers from Seattle-Tacoma-Bellevue MSA, that is the Black and non-Black as well as white/non-white quantities. In the former case which I will look at first, let $\beta_{i}^b$ be the fraction of Black populations who move, and let $\beta_{i}^n$ be the fraction of non-Black populations who move. We want to estimate these quantities from aggregate variables $X_i$ (the fraction of people who are Black), $T_i$ (the fraction of people who moved), and $N_i$ (the known total population of people).

To start, we can plot $X_i$ against $T_i$...

Goodman's ecological regression?

According to Ecological Inference - New Methodological Strategies https://gking.harvard.edu/files/eiintro.pdf, using King's EI has 3 assumptions.
- one cluster (not distinguishable)
- no spatial autocorrelation
- mean independence between regressor and unknowns conditional on $X_i$ and $Z_i$

These allow one to compute a posterior (or sampling) distribution of the two unknowns in each "precinct" in the voting example.

In EI, quantities of interest are not parameters of the likelihood, but come from conditioning on $T_i$ (the fraction of people who voted in the book example) and producing a posterior for (in the book's example, the proportion of Black voters vs proportion of white voters). In the migration case, we could condition on the fraction of people who moved, producing a posterior for the proportion of Black movers vs proportion of white (or nonblack) movers for each metro area.

Conditioning on $T$ is "widely regarded as a critical step in applying the EI model".

## Load in Data
### Race Data
NHGIS code:  U7J
        U7J001:      Total
        U7J002:      White alone
        U7J003:      Black or African American alone
        U7J004:      American Indian and Alaska Native alone
        U7J005:      Asian alone
        U7J006:      Native Hawaiian and Other Pacific Islander alone
        U7J007:      Some Other Race alone
        U7J008:      Two or More Races
```{r cars}
# race data by cbsa
race_by_cbsa_2020 <- read.csv("data/nhgis0007_ds258_2020_cbsa.csv")
head(race_by_cbsa_2020)
```
```{r}
race_by_cbsa_2020 <- race_by_cbsa_2020 %>% 
  select(c(GEOCODE, CBSA, NAME, U7J001, U7J002, U7J003,
                  U7J004, U7J005, U7J006, U7J007, U7J008)) %>% 
  setnames(old=c("U7J001", "U7J002", "U7J003",
                  "U7J004", "U7J005", "U7J006", "U7J007", "U7J008"),
           new=c("tot", "white", "black", "american_ind_ak", "asian", "native_hawaiian_pi", "some_other_alone", "two_plus")) %>% 
  # filter for just metro areas
  filter(str_detect(NAME, "Metro"))

```

```{r}
# 2015 mover data by msa (race breakdown)
sea_flows_2015_race <- get_flows(
  geography = "cbsa",
  breakdown_labels = TRUE,
  breakdown = "RACE",
  msa = 42660,
  year = 2015,
  geometry = TRUE
)

head(sea_flows_2015_race)

# 2020 mover data by msa (race breakdown unavailable)
sea_flows_2020 <- get_flows(
  geography = "cbsa",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2020,
  geometry = TRUE
)

sea_flows_2020 <- sea_flows_2020 %>% 
  dplyr::filter(variable == "MOVEDOUT")
head(sea_flows_2020)

# 2019 test
sea_flows_2019 <- get_flows(
  geography = "cbsa",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2020,
  geometry = TRUE
)

head(sea_flows_2020)
```

```{r}
race_by_cbsa_2020$GEOCODE <- as.character(race_by_cbsa_2020$GEOCODE)

flows_race_metro <- inner_join(race_by_cbsa_2020, sea_flows_2020, by = c("GEOCODE" ="GEOID2")) %>% 
  select(-c(FULL1_NAME, FULL2_NAME, GEOID1, variable, moe, centroid1, centroid2)) %>% 
  setnames(old=c("estimate"), new=c("sea_movers"))
```


```{r}
# define a function to calculate percentages of each race given dataset
calc_percentages <- function(data){
  race_cols <- c("white", "black", "american_ind_ak", "asian", "native_hawaiian_pi", "some_other_alone", "two_plus")
  migration_col <- c("sea_movers")
  
  for (race in race_cols) {
    data[[race]] <- (data[[race]] / data$tot) * 100
  }
  
  data[[migration_col]] <- (data[[migration_col]] / data$tot) * 100
  
  return(data)
}
```

```{r}
calc_percentages(flows_race_metro)
```

```{r}
ggplot(flows_race_metro, aes(x = black, y = sea_movers)) +
  geom_point()
```

```{r}
ggplot(flows_race_metro, aes(x = white, y = sea_movers)) +
  geom_point()
```

```{r}
# filter for just movedOut
flows.race.2015 <- sea_flows_2015_race %>% 
  dplyr::filter(variable == "MOVEDOUT")
```
```{r}
# wrangling race data
```




## 2015 Exploration

Questions for 2015 with the racial breakdowns:
- what do the distributions of movers look like for each race?
- Who is moving? What proportions?
- Compare other years?

## 2019 Exploration

Questions for 2019/2020:
- how do patterns differ between 2019 and 2020?

## 2020 Exploration

## Results/Discuss?

```{r}

```


