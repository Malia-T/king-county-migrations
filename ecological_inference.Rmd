---
title: "Ecological Inference"
author: "Malia Cortez"
date: "2024-06-23"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(tidyverse)
library(tidyr)
library(stringr)
library(data.table)
library(readxl)
library(tigris)

# statistics
library(stats)

# mapping and plotting
library(ggplot2)
library(terra)
library(mapdeck)
library(sf)

library(brms)

# modeling
#library(tree)
#library(randomForest)
#library(randomForestExplainer)
#library(keras)

# extracting survey/IPUMS/census data
#library(survey)
#library(srvyr)
library(ipumsr)
library(tidycensus)
```

The purpose of this notebook is to explore ecological inference methods for the migration data. How do movers break down by race? Are there distinguishable groups between white/non-white, black/non-black populations?

## Notes

To help with my understanding, here is the notation for this problem.

If all assumptions are met and we can use King's EI, for each MSA $i$, we want to estimate the race composition of movers from Seattle-Tacoma-Bellevue MSA, that is the Black and non-Black as well as white/non-white quantities. In the former case which I will look at first, let $\beta_{i}^b$ be the fraction of Black populations who move, and let $\beta_{i}^n$ be the fraction of non-Black populations who move. We want to estimate these quantities from aggregate variables $X_i$ (the fraction of people who are Black), $T_i$ (the fraction of people who moved), and $N_i$ (the known total population of people).

To start, we can plot $X_i$ against $T_i$...

Goodman's ecological regression?

According to https://gking.harvard.edu/files/eiintro.pdf, using King's EI has 3 assumptions.

## Load in Data
### Race Data
NHGIS code:  U7J
        U7J001:      Total
        U7J002:      White alone
        U7J003:      Black or African American alone
        U7J004:      American Indian and Alaska Native alone
        U7J005:      Asian alone
        U7J006:      Native Hawaiian and Other Pacific Islander alone
        U7J007:      Some Other Race alone
        U7J008:      Two or More Races
```{r cars}
# race data by cbsa
race_by_cbsa_2020 <- read.csv("data/nhgis0007_ds258_2020_cbsa.csv")
head(race_by_cbsa_2020)
```

```{r}
# 2015 mover data by msa (race breakdown)
sea_flows_2015_race <- get_flows(
  geography = "cbsa",
  breakdown_labels = TRUE,
  breakdown = "RACE",
  msa = 42660,
  year = 2015,
  geometry = TRUE
)

head(sea_flows_2015_race)

# 2020 mover data by msa (race breakdown unavailable)
sea_flows_2020 <- get_flows(
  geography = "cbsa",
  breakdown_labels = TRUE,
  msa = 42660,
  year = 2020,
  geometry = TRUE
)

head(sea_flows_2020)
```

```{r}
# filter for just movedOut
flows.race.2015 <- sea_flows_2015_race %>% 
  dplyr::filter(variable == "MOVEDOUT")
```


## 2015 Exploration

Questions for 2015 with the racial breakdowns:
- what do the distributions of movers look like for each race?
- Who is moving?

## 2020 Exploration

## Results/Discuss?

```{r}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
